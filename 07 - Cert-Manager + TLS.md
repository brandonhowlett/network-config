# Cert-Manager Installation Guide via Helm for K3s

This guide outlines how to install **Cert-Manager** in a K3s cluster using Helm, including handling CRDs and applying supplemental YAML files such as ClusterIssuers or Certificates.

---

## **1. Pre-Requisites**

- A running K3s cluster (`kubectl get nodes` shows all nodes Ready)
- Helm installed locally
- Optional: SOPS operator installed if using encrypted secrets

---

## **2. Add the Helm Repository**

```bash
helm repo add jetstack https://charts.jetstack.io
helm repo update
```

---

## **3. Install Cert-Manager CRDs**

Cert-Manager CRDs must be installed first before deploying the main chart.

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.1/cert-manager.crds.yaml
```

- **Verify CRDs**:

```bash
kubectl get crds | grep cert-manager.io
```

You should see CRDs like:

- `certificates.cert-manager.io`
- `issuers.cert-manager.io`
- `clusterissuers.cert-manager.io`
- `orders.cert-manager.io`
- `challenges.cert-manager.io`

---

## **4. Create Namespace**

```bash
kubectl create namespace cert-manager
```

---

## **5. Install Cert-Manager via Helm**

```bash
helm upgrade --install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --version v1.14.1 \
  --set installCRDs=false
```

- `installCRDs=false` because we applied them manually in Step 3.

---

## **6. Verify Installation**

```bash
kubectl get pods -n cert-manager
```

Expected output:

```
NAME                                   READY   STATUS    RESTARTS   AGE
cert-manager-<hash>                    1/1     Running   0          <age>
cert-manager-cainjector-<hash>         1/1     Running   0          <age>
cert-manager-webhook-<hash>            1/1     Running   0          <age>
```

---

## **7. Apply Supplemental YAML Files**

Cert-Manager relies on **Issuer** or **ClusterIssuer** objects to issue certificates.

### Example: Internal Root CA ClusterIssuer

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: clusterissuer-lan-smarthome
spec:
  ca:
    secretName: smarthome-root-ca
```

- Apply the ClusterIssuer:

```bash
kubectl apply -f clusterissuer-lan-smarthome.yaml
```

### Example: Certificate

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: smarthome-wildcard
  namespace: traefik
spec:
  secretName: smarthome-wildcard-tls
  duration: 2160h
  renewBefore: 360h
  issuerRef:
    name: clusterissuer-lan-smarthome
    kind: ClusterIssuer
  dnsNames:
    - "*.smart.home"
    - "smart.home"
```

- Apply the certificate:

```bash
kubectl apply -f smarthome-wildcard.yaml
```

---

## **8. Verify Certificates**

```bash
kubectl get certificates -n traefik
kubectl describe certificate smarthome-wildcard -n traefik
kubectl get secret smarthome-wildcard-tls -n traefik
```

- Ensure the certificate is `Ready=True`.

---

## **9. Optional: Troubleshooting**

- ClusterIssuer not ready:

```bash
kubectl describe clusterissuer clusterissuer-lan-smarthome
```

Common issue: `secrets "smarthome-root-ca" not found`. Make sure the root CA secret exists:

```bash
kubectl get secret -n cert-manager
kubectl apply -f smarthome-root-ca.yaml
```

- Check Cert-Manager logs:

```bash
kubectl logs -n cert-manager deploy/cert-manager
kubectl logs -n cert-manager deploy/cert-manager-webhook
kubectl logs -n cert-manager deploy/cert-manager-cainjector
```

---

## **10. Notes**

- All services that need TLS (Traefik, internal apps) can now reference the secrets generated by Cert-Manager.
- Certificates automatically renew according to `duration` and `renewBefore`.
- Keep CRDs applied manually or versioned with your cluster; do **not delete CRDs** while active certificates exist.

